---
title : "[CS] Nginx.conf"
tags : Cs
---



# Nginx.conf

#### Nginx의 기본 원리

Nginx는 하나의 mastere process와 하나 이상의 worker process로 구성되어 있다.

* master process : configuration file을 읽고 실행하며, worker process들을 관리한다.
* worker process : 유저가 요청한 request에 대한 실제 작업을 수행한다.

<br/>

#### Core

```
user k3 informix; #(default : www-data)
worker_processes 1;
error_log logs/error.log level;
pid logs/nginx.pid;
```

`user`

nginx는 마스터 프로세스와 워커 프로세스로 동작하고, 워커 프로세스가 실질적인 웹서버의 역할을 수행하는데 user 지시어는 워커 프로세스의 권한을 지정한다. 만약 user의 값이 root로 되어 있다면 워커 프로세스를 root의 권한으로 동작하게되고, 워커 프로세스를 악의적 사용자가 제어하게 된다면 해당 머신을 root 사용자의 권한으로 원격제어하게 되는 것으로 보안상 위험하다.

`worker_processes`

워커 프로세스를 몇개 생성할 것인지를 지정하는 지시어이다. 이 값이 1이라면 모든 요청을 하나의 프로세스로 실행하겠다는 의미이다. CPU 코어가 여러개 있는데 이 값이 1이면 하나의 코어만 사용하게 되는 셈으로 코어의 숫자만큼 지정하는것이 좋다.

`error_log`

가장 상세한 로그 레벨부터 차례로 debug, info, notice, warn, error, crit가 있다. 에러 로그를 저장할 path와 level을 지정해주면 된다.

로그 출력 방향을 /dev/null로 전환하면 에러 로그를 해제하는것과 같은 효과를 얻을 수 있다.

```
error_log /dev/null crit;
```

`pid`

nginx 마스터 프로세스의 id정보가 저장된다.

<br/>

#### Events

nginx는 비동기 이벤트 방식(Event Driven)의 처리 방식을 가지고 있는데 Events block은 그 처리에 관련된 옵션을 설정하는 곳이다. 네트워크 동작 방법과 관련된 설정

```
events {
    worker_connections  8192;
}
```

`worker_connections`

하나의 프로세스가 처리할 수 있는 커넥션의 수

최대 접속자수 = worker_processes * worker_connections

<br/>

#### Http

웹 서버에 대한 동작 설정이다. HTTP 웹 트래픽 처리 전반에 대해 기술하므로 **universal directive** 라고 부르는데 그 이유는 nginx가 serve하는 모든 웹사이트의 configuration에 전달되기 때문이다.

http://nginx.org/en/docs/http/ngx_http_core_module.html#server_tokens를 참고하여 http block에서 지시어를 확인할 수 있다.

```
http {
	include /etc/nginx/mime.types;
	default_type    application/octet-stream;
	
	log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';
	
	access_log    /var/log/nginx/access.log    main;
	
	server_tokens off;
    sendfile on;
    client_max_body_size 10M;
	#tcp_nopush on;
	
	keepalive_timeout 65;
	
	charset utf-8;
	index index.php index.html;

	ssl_certificate /k3/ssl/afreecatv.com/cert.crt;
	ssl_certificate_key /k3/ssl/afreecatv.com/key.pem;
	
	#gzip  on;
	error_page 404 403 https://www.afreecatv.com/not_found.htm;
}
```

`include /etc/nginx/mime.types;`

mime.types 파일을 보면 Content-Type유형을 명시해 놨다. nginx에 사용할 수 있는 Content-Type 설정으로 생각된다.

`default_type`

Content-Type의 default type 설정

`log_format main`

log_format의 양식 이름을 main으로 설정하고 어떤 형식으로 보여줄지를 설정한다.

관련된 자료는 https://emessell.tistory.com/101에서 확인할 수 있다.

`access_log`

서버에 접속한 유저의 정보를 지정한 경로에 기록한다. main으로 지정한 log_format 양식을 사용하는 듯하다.

`servers tokens off`

오류 페이지 및 "서버"응답 헤더 필드에서 nginx 버전을 내보내는 것을 활성화 또는 비활성화 하는 지시어

`sendfile`

nginx에서 정적파일을 보낼 수 있도록 설정합니다.

`client_max_body_size 10M;`

이 값은 업로드 할 수 있는 용량의 크기를 지정한다. 이 지시자의 기본값은 1MB인데, 더 많은 파일의 업로드를 허용하려면 이 값을 늘려줘야 한다.

`tcp_nopush on;`

`TCP_NOPUSH`FreeBSD의 `TCP_CORK`소켓 옵션 또는 Linux 의 소켓 옵션 사용을 활성화 또는 비활성화합니다 . 옵션은 [sendfile](http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile) 이 사용되는 경우에만 활성화 된다.

`keepalive_timeout 65;`

클라이언트에서 해당 서버로 `keepalive` 커넥션을 유지할 수 있는 시간을 설정한다. 너무 길면 요청이 없는 클라이언트와의 커넥션을 연결하고 있기 때문에 자원의 낭비가 발생한다.

`ssl_certificate`

https와 관련된 지시어인듯하다.

`error_page 404 403` 

default error page로 404, 403에러가 발생하면 보여주는 page이다. 이외에도 여러 에러코드를 넣어줄 수 있다.

<br/>

#### Server

가상 호스트(Virtual Host)는 하나의 컴퓨터로 마치 여러대의 컴퓨터가 존재하는 것처럼 동작하도록 한다는 뜻이다.

![가상호스트](https://user-images.githubusercontent.com/46040824/113095129-e64e3200-922d-11eb-943d-ba26638ca0cc.PNG){width=250px}

```

```



출처

* https://opentutorials.org/module/384/4530
* https://whatisthenext.tistory.com/123
* https://architectophile.tistory.com/12
* https://juneyr.dev/nginx-basics
* https://technerd.tistory.com/19 master process & worker process
* https://extrememanual.net/10140 : http - log_format
* https://www.lesstif.com/system-admin/nginx-load-balancing-35357063.html http - upstream 로드밸런싱
* https://judo0179.tistory.com/16 http - upstream 로드밸런싱
* https://deeplify.dev/server/web/nginx-configuration http
* https://opentutorials.org/module/384/4529 server

