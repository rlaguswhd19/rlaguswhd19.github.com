---
title : "[CS] Nginx"
tags : 
 - Cs
---



# Nginx

Nginx는 동시접속 처리에 특화된 웹 서버 프로그램으로 Apache보다 동작이 단순하고 전달자 역할만 하기 때문에 **동시접속** 처리에 특화되어 있다.

동시접속자(약 700명) 이상이라면 서버를 증설하거나 nginx 환경을 권장한다고 한다.

보안과 속도를 최적화 시키려는 노력에서 탄생한 웹서버이며, 사용이 매우 심플하고 규모가 작은 서비스이면서 정적 데이터 처리가 많은 서비스에 적합

<br/>

#### Nginx의 역할

1. 정적 파일을 처리하는 HTTP 서버로서의 역할

   웹서버의 역할은 HTML, CSS, Javascript, 이미지와 같은 정보를 웹 브라우저(Chrome, Iexplore, Opera, Firefox 등)에 전송하는 역할을 한다. (HTTP 프로토콜을 준수)

2. 응용프로그램 서버에 요청을 보내는 리버스 프록시로서의 역할

   리버스 프록시는 클라이언트와 서버 통신 중간에서 대신 통신을 해주는 서버를 의미한다.

   이렇게 구성된 이유는 

   * 보안때문이다. WAS는 대부분 DB 서버와 연결되어 있어 WAS가 최전방에서 요청을 받게되면 보안에 취약해진다. 리버스 프록시를 두고 사용하면 WS가 WAS와 통신하여 결과를 클라이언트에 제공하는 방식으로 서비스를 하게 된다.

   * 요청에 대한 버퍼링이 있기 때문이다. 클라이언트가 직접 App 서버에 요청을 하는 경우 프로세스 1개가 응답 대기 상태가 되어야만 한다. 따라서 프록시 서버가 요청을 배분하는 역할을 한다.

     ###### ps nginx.conf 파일에서 location 지시어를 사용해 요청을 배분한다



<br/>

# Apache-Nginx 비교

##### 2021 웹서버 시장 점유율

![시장점유율](https://user-images.githubusercontent.com/46040824/112952805-dd028e00-9177-11eb-8b8f-0e9f5f8f39e5.PNG)

<br/>

### Apache 2.2

##### 요청 하나 당 프로세스(또는 쓰레드)가 처리하는 구조

* 요청이 많을수록 CPU와 메모리 사용이 증가하기 때문에 성능 저하가 있을 수 있다.
* Apache 서버의 프로세스가 블록킹이 되면 요청을 처리하지 못하고, 처리가 완료 될 때까지 계속 대기하는 일이 발생한다.

이를 해결하기 위해 **Keep Alive**를 활성화 함으로 해결이 가능하나 이로 인해 대량 접속 시 효율이 급격하게 감소하는 다른 문제점 발생

<br/>

##### Keep Alive

HTTP 프로토콜의 특성상 한 번 통신이 이루어지면 접속을 끊지만, KeepAlive On 상태에서는 KeepAliveTimeOut 시간 동안 접속을 끊지 않고 다음 접속을 기다린다. 한 번 연결된 클라이언트와의 통신을 유지하고 있기 때문에 다음 통신 시에 Connection을 생성하고 끊는 작업이 필요없어 성능 향상을 기대 할 수 있다. 정적 자원으로만 구성된 웹 서버는 KeepAlive On으로 설정할 경우 약 50%의 성능 향상을 보인다고 한다.

하지만 서버가 바쁜 상황에서 KeepAlive On으로 설정할 경우 모든 요청 마다 연결을 유지하여 프로세스 수가 기하급수적으로 늘어나 MaxClient를 초과하고 메모리를 많이 사용하게 되어 성능 저하의 원인이 된다. 그래서 등장한것이 Event MPM 방식이다.

<br/>

##### Apache MPM 방식

##### worker

* 자식 프로세스들이 각각 여러 쓰레드를 사용하며, 각 쓰레드는 한번에 한 연결을 담당한다.
* 스레드간 메모리를 공유하여 메모리 사용량이 비교적 적음
* 통신량이 많은, 동시 접속자가 많은 서버에 적합

---

##### prefork

* 자식 프로세스를 미리 준비해두는 방식
* 자식 프로세스는 최대 1024개
* 하나의 자식 프로세스당 1개의 스레드 연결
* 스레드간 메모리 공유를 하지 않아 독립적으로 사용하여 안정적이나 메모리를 많이 사용함
* 한 클아이언트가 맺은 접속이 완전히 끝나지 않는 한 스레드, 프로세스가 죽지 않는다.

<br/>

### Apache 2.4

##### Event Mpm(Event Multi Processing Module)

Keep Alive의 문제점을 해결하기 위해서 Apache 2.4부터 생성된 방식이다. worker방식을 기반으로 Keep Alive한 아파치 요청을 그대로 맺는 것이 아니라, 요청을 받아 처리하는 스레드를 따로 생성하여 분산하여 처리하는 방식이다.

(Keep Alive는 요청을 받는 스레드가 하고 요청은 다른 스레드가 처리한다. 라고 이해함)

<br/>

### Nginx

Nginx는 프로그램의 흐름이 이벤트에 의해 결정되는 Event Driven 방식을 사용한다.

적은 수의 쓰레드로 효율적인 일 처리를 하며, 쓰레드를 적게 사용 하기 때문에 쓰레드당 할당되는 메모리도 적게 사용하는 구조이다. 그러나 모듈 개발이 어려우며 다양한 모듈이 없다는 것이 단점(모듈?)

![nginx 방식](https://user-images.githubusercontent.com/46040824/113077589-6368af80-920c-11eb-9068-9853b5a34d92.PNG)

PHP 모듈 등을 직접 적재할 수 있는 Apache가 구조상 이점이 있기에 복잡한 웹 사이트의 경우 Apache가 적합하다. 세션 클러스터링 같은 특별한 목적을 추가적으로 수행하는 세팅을 할 경우에는 별도의 과정을 거쳐야 하기 때문에, 이러한 별도의 작업이 많이 필요한 서비스의 경우에도 유지 보수 측면에서 Apache가 유용하다. 결과적으로 안전성과 확장성, 호환성에서는 Apache, 성능면에서는 Nginx를 사용하는게 좋다.

###### 출처

* https://victorydntmd.tistory.com/231
* https://whatisthenext.tistory.com/123
* https://bkjeon1614.tistory.com/23
* https://megaidc.net/board_kRVd58/17022