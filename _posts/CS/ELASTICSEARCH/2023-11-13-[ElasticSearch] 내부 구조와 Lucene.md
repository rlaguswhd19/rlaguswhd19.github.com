---
title : "[ElasticSearch] 내부 구조와 Lucene"
tags :
 - ElasticSearch
---

# ElasticSearch 내부 구조와 Lucene

엘라스틱서치는 아파치 루씬을 코어 라이브러리로 사용하고 있다.

루씬은 문서를 색인하고 검색하는 라이브러리다.

<br/>

### Lucene flush

문서 색인 요청이 들어오면 루씬은 문서를 분석해서 역색인을 생성한다. 최초 생성 자체는 메모리 버퍼에 들어간다. 문서색인, 업데이트, 삭제 등의 작업이 수행되면 루신은 이러한 변경들을 메모리에 들고 있다가 주기적으로 디스크에 `flush` 한다.

메모리 버퍼에 들고있다가 검색이 가능한 세그먼트로 만들어준다. 루씬은 색인한 정보를 파일로 저장하기 때문에 루씬에서 검색을 하려면 먼저 파일을 열어야한다. 파일을 연 시점에 색인이 완료된 문서만 검색할 수 있다. 변경사항을 검색하고 싶은 경우 파일을 새로 열어야한다. 이러한 작업을 엘라스틱서치에서는 `refresh`라고 한다. `refresh`는 어느 정도 비용이 있는 작업이기 때문에 변경될때마다가 아닌 적절한 간격마다 주기적으로 실행한다.

<br/>

### Lucene commit

루씬의 `flush`는 시스템의 페이지 캐시에 데이터를 넘겨주는 것까지만 보장할 뿐 디스크에 안전하게 기록되는 것까지 보장하지는 않는다. 따라서 `fsync`시스템 콜을 통해 주기적으로 캐시와 디스크에 기록된 내용의 싱크를 맞추는 작업을 한다. 이를 루씬 `commit`이라고 한다. 엘라스틱 서치의 `flush` 작업은 내부적으로 루씬 `commit`을 거친다. 루씬의 `flush`와 엘라스틱서치의 `flush`는 다른 개념이다. 엘라스틱서치의 `flush`는 `refresh`보다 비용이 더 드는 작업이다. `refresh`와 마찬가지로 적절한 주기로 수행된다.

<br/>

### 세그먼트

디스크에 기록된 파일들이 모이면 세그먼트라는 단위가 된다. 세그먼트는 루씬의 검색 대상이다. 세그먼트 자체는 불면인 데이터로 구성되어 있어 새로운 문서는 새 세그먼트로 생성되고 삭제의 경우는 삭제 플래그만 표시한다. 기존 문서에 업데이트가 발생하면 세그먼트에 삭제 플래그를 주고 새로 생성한다. 불변인 세그먼트를 계속 가지고 있을 수 없어 삭제작업 및 병합을 수행한다.

<br/>

### Lucene Index와 Elasticsearch Index

여러 세그먼트가 모이면 하나의 루씬 인덱스가 된다. 루씬은 이 인덱스 내에서만 검색이 가능하다. 엘라스틱서치의 샤드는 인덱스 하나를 래핑한 단위이다. 샤드가 여러개 모이면 엘라스틱서치 인덱스가 된다. 엘라스틱서치의 레벨에서는 모든 샤드에 있는 문서 검색이 가능하다.

<br/>

### Translog

엘라스틱서치에 색인된 문서들은 루씬 commit까지 완료되어야 디스크에 안전하게 기록된다. commit은 큰 비용의 작업이다. 하지만 변경사항을 모아서 commit한다면 장애가 발생할때 데이터 유실의 우려가 있다. 이를 해결하기 위해 모든 작업마다 translog를 남긴다.